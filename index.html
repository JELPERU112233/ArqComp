<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ArqComp AR</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');
:root{
  --blue:#00d4ff; --pink:#ff2d78; --green:#00ff88;
  --orange:#ff9900; --yellow:#ffff00; --purple:#cc44ff;
  --bg:#010c18; --panel:rgba(2,12,24,0.93); --border:rgba(0,180,255,0.18);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Share Tech Mono',monospace;background:#000;color:#ccc}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE: AR IS THE DEFAULT VIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#ar-view{
  position:fixed;inset:0;z-index:10;
  display:none; /* shown on mobile */
  flex-direction:column;
  overflow:hidden;
}
body.is-mobile #ar-view{display:flex}
body.is-mobile #desktop-view{display:none}

/* Space background canvas */
#space-canvas{
  position:absolute;inset:0;width:100%;height:100%;z-index:0;
  background:#00060f;
}
/* Nebula / depth layers ‚Äì move with gyro at different speeds */
#nebula{
  position:absolute;
  inset:-25%;width:150%;height:150%;
  z-index:1;pointer-events:none;
  background:
    radial-gradient(ellipse 55% 38% at 28% 38%, rgba(0,100,220,.13) 0%, transparent 70%),
    radial-gradient(ellipse 48% 32% at 72% 62%, rgba(140,0,210,.10) 0%, transparent 70%),
    radial-gradient(ellipse 38% 28% at 52% 22%, rgba(0,190,140,.08) 0%, transparent 70%);
  will-change:transform;
}
/* Holographic grid ‚Äì subtle, moves with gyro */
#holo-grid{
  position:absolute;inset:-10%;width:120%;height:120%;
  z-index:2;pointer-events:none;
  background-image:
    linear-gradient(rgba(0,180,255,.05) 1px,transparent 1px),
    linear-gradient(90deg,rgba(0,180,255,.05) 1px,transparent 1px);
  background-size:44px 44px;
  will-change:transform;
}

/* Scanlines */
#scanlines{
  position:absolute;inset:0;pointer-events:none;z-index:5;
  background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,180,255,.018) 3px,rgba(0,180,255,.018) 4px);
}
/* Vignette */
#vignette{
  position:absolute;inset:0;pointer-events:none;z-index:6;
  background:radial-gradient(ellipse at 50% 50%, transparent 50%, rgba(0,0,0,.65) 100%);
}
/* Gyro indicator in HUD */
#gyro-indicator{
  display:flex;align-items:center;gap:6px;
  font-size:8px;letter-spacing:2px;color:rgba(0,212,255,.55);
}
#gyro-icon{font-size:15px;display:inline-block;transition:transform .15s linear}
#gyro-bar{width:48px;height:4px;background:rgba(0,212,255,.12);border-radius:2px;overflow:hidden}
#gyro-fill{height:100%;background:var(--blue);border-radius:2px;width:0%;transition:width .12s}

/* HUD bar */
#hud{
  position:absolute;top:0;left:0;right:0;z-index:30;
  padding:max(env(safe-area-inset-top,14px),14px) 14px 10px;
  background:linear-gradient(180deg,rgba(0,8,18,.8) 0%,transparent 100%);
  display:flex;align-items:center;justify-content:space-between;
  pointer-events:none;
}
#hud-title{
  font-family:'Orbitron',monospace;font-size:11px;font-weight:900;
  letter-spacing:5px;color:var(--blue);
  text-shadow:0 0 14px var(--blue),0 0 30px rgba(0,212,255,.4);
}
/* (hud-badge removed ‚Äî replaced by gyro indicator) */

/* ‚îÄ‚îÄ 3D CUBE SCENE ‚îÄ‚îÄ */
#ar-scene{
  position:absolute;inset:0;z-index:20;
  pointer-events:none;
}

/* individual cube wrapper ‚Äì positioned via JS */
.arc{
  position:absolute;
  width:110px;height:110px;
  perspective:500px;
  pointer-events:all;
  cursor:pointer;
  transform-origin:center center;
  animation:floatCube 4s ease-in-out infinite;
}
.arc:nth-child(2){animation-delay:-.8s}
.arc:nth-child(3){animation-delay:-1.6s}
.arc:nth-child(4){animation-delay:-2.4s}
@keyframes floatCube{
  0%,100%{transform:translateY(0px)}
  50%{transform:translateY(-8px)}
}

.cube3{
  width:80px;height:80px;
  position:relative;
  transform-style:preserve-3d;
  transform:rotateX(-20deg) rotateY(35deg);
  margin:0 auto;
  transition:transform .4s ease;
}
.arc.tapped .cube3{transform:rotateX(-25deg) rotateY(55deg) scale(1.12)}

.face{
  position:absolute;width:80px;height:80px;
  border:1.5px solid;
  display:flex;align-items:center;justify-content:center;
  font-family:'Orbitron',monospace;font-size:9px;font-weight:700;
  letter-spacing:2px;
  backface-visibility:hidden;
}
/* front */
.face.f{transform:translateZ(40px)}
/* back */
.face.bk{transform:translateZ(-40px) rotateY(180deg)}
/* right */
.face.r{transform:rotateY(90deg) translateZ(40px)}
/* left */
.face.l{transform:rotateY(-90deg) translateZ(40px)}
/* top */
.face.t{transform:rotateX(90deg) translateZ(40px)}
/* bottom */
.face.bo{transform:rotateX(-90deg) translateZ(40px)}

/* RAM: blue */
.cube-ram .face{border-color:rgba(0,212,255,.5);background:rgba(0,30,70,.82)}
.cube-ram .face.f{background:rgba(0,50,120,.85);border-color:var(--blue)}
.cube-ram .face.t{background:rgba(0,40,100,.7)}

/* CACHE: pink */
.cube-cache .face{border-color:rgba(255,45,120,.5);background:rgba(60,0,40,.82)}
.cube-cache .face.f{background:rgba(100,0,60,.85);border-color:var(--pink)}
.cube-cache .face.t{background:rgba(80,0,50,.7)}

/* REG: green */
.cube-reg .face{border-color:rgba(0,255,136,.5);background:rgba(0,40,20,.82)}
.cube-reg .face.f{background:rgba(0,70,30,.85);border-color:var(--green)}
.cube-reg .face.t{background:rgba(0,60,25,.7)}

/* ULA: orange */
.cube-ula .face{border-color:rgba(255,153,0,.5);background:rgba(50,20,0,.82)}
.cube-ula .face.f{background:rgba(90,35,0,.85);border-color:var(--orange)}
.cube-ula .face.t{background:rgba(70,28,0,.7)}

/* glow ring under cube */
.cube-glow{
  width:70px;height:14px;
  border-radius:50%;
  margin:2px auto 0;
  opacity:.5;
  filter:blur(6px);
  animation:glowPulse 2s ease infinite;
}
@keyframes glowPulse{0%,100%{opacity:.35;transform:scaleX(1)}50%{opacity:.65;transform:scaleX(1.1)}}
.cube-ram .cube-glow{background:var(--blue)}
.cube-cache .cube-glow{background:var(--pink)}
.cube-reg .cube-glow{background:var(--green)}
.cube-ula .cube-glow{background:var(--orange)}

/* label below cube */
.cube-name{
  text-align:center;margin-top:6px;
  font-family:'Orbitron',monospace;font-size:11px;font-weight:700;
  letter-spacing:3px;
  text-shadow:0 0 10px currentColor;
}
.cube-sub{text-align:center;font-size:7px;letter-spacing:2px;opacity:.5;margin-top:2px}
.cube-hint{
  text-align:center;font-size:7px;letter-spacing:1px;
  margin-top:4px;opacity:.4;
  animation:pulseHint 1.2s ease infinite alternate;
}
@keyframes pulseHint{from{opacity:.2}to{opacity:.6}}

/* active state glow */
.arc.active-glow .cube3{
  filter:drop-shadow(0 0 14px currentColor);
  animation:cubeActivePulse .5s ease infinite alternate;
}
@keyframes cubeActivePulse{from{transform:rotateX(-20deg) rotateY(35deg) scale(1.0)}to{transform:rotateX(-22deg) rotateY(38deg) scale(1.08)}}

/* ‚îÄ‚îÄ CONNECTOR CANVAS ‚îÄ‚îÄ */
#conn-canvas{position:absolute;inset:0;z-index:15;pointer-events:none}

/* ‚îÄ‚îÄ BIT PARTICLE OVERLAY ‚îÄ‚îÄ */
#bit-layer{position:absolute;inset:0;z-index:25;pointer-events:none}
.bit-dot{
  position:absolute;
  width:20px;height:20px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-family:'Orbitron',monospace;font-size:8px;font-weight:700;color:#fff;
  pointer-events:none;opacity:0;
}

/* ‚îÄ‚îÄ STEP BANNER ‚îÄ‚îÄ */
#step-banner{
  position:absolute;left:50%;z-index:35;
  transform:translateX(-50%);
  bottom:calc(var(--kbd-h,220px) + 8px);
  background:rgba(0,8,18,.85);border:1px solid;border-radius:24px;
  padding:7px 18px;font-size:10px;letter-spacing:3px;
  white-space:nowrap;opacity:0;
  transition:opacity .3s,border-color .3s,color .3s;
  backdrop-filter:blur(10px);
  pointer-events:none;
}
#step-banner.show{opacity:1}

/* ‚îÄ‚îÄ INSPECT PANEL (slides from bottom) ‚îÄ‚îÄ */
#inspect{
  position:absolute;bottom:0;left:0;right:0;z-index:50;
  background:var(--panel);
  border-top:1px solid var(--border);
  border-radius:22px 22px 0 0;
  padding:0 18px calc(20px + env(safe-area-inset-bottom,0px));
  transform:translateY(100%);
  transition:transform .38s cubic-bezier(.25,.8,.25,1);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  max-height:60vh;overflow-y:auto;-webkit-overflow-scrolling:touch;
}
#inspect.open{transform:translateY(0)}
#inspect-handle{width:40px;height:4px;background:rgba(255,255,255,.18);border-radius:2px;margin:12px auto 14px}
#inspect-close{
  position:absolute;top:14px;right:16px;
  width:30px;height:30px;border-radius:50%;
  background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);
  color:#888;font-size:15px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
}
#inspect-title{font-family:'Orbitron',monospace;font-size:18px;font-weight:900;letter-spacing:4px;text-align:center;margin-bottom:3px}
#inspect-sub{font-size:9px;letter-spacing:3px;opacity:.4;text-align:center;margin-bottom:12px}
#inspect-status{text-align:center;margin-bottom:14px}
.ibadge{display:inline-flex;align-items:center;gap:5px;padding:3px 12px;border-radius:12px;font-size:9px;letter-spacing:2px}
.ibadge.idle{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);color:#446}
.ibadge.active{background:rgba(0,255,136,.12);border:1px solid rgba(0,255,136,.3);color:var(--green)}
.ibadge.computing{background:rgba(255,153,0,.12);border:1px solid rgba(255,153,0,.3);color:var(--orange)}
.idot{width:6px;height:6px;border-radius:50%;background:currentColor;animation:bdot 1s infinite}

.irow{
  display:flex;align-items:center;gap:10px;
  padding:8px 0;border-bottom:1px solid rgba(0,180,255,.08);
  font-size:11px;
}
.irow:last-child{border-bottom:none}
.ikey{font-size:9px;letter-spacing:1px;color:#336;min-width:110px;flex-shrink:0}
.ival{font-family:'Orbitron',monospace;font-size:11px;flex:1}
.ival.c-blue{color:var(--blue)} .ival.c-pink{color:var(--pink)}
.ival.c-green{color:var(--green)} .ival.c-orange{color:var(--orange)}
.ival.c-yellow{color:var(--yellow);text-shadow:0 0 8px rgba(255,255,0,.5)}
/* live blinking value */
.ival.live::after{content:'';display:inline-block;width:6px;height:6px;border-radius:50%;background:currentColor;margin-left:5px;animation:bdot .6s infinite;vertical-align:middle}

/* ‚îÄ‚îÄ KEYBOARD DRAWER ‚îÄ‚îÄ */
#kbd-drawer{
  position:absolute;bottom:0;left:0;right:0;z-index:60;
  background:var(--panel);
  border-top:1px solid var(--border);
  border-radius:22px 22px 0 0;
  padding:10px 16px calc(14px + env(safe-area-inset-bottom,0px));
  transform:translateY(100%);
  transition:transform .38s cubic-bezier(.25,.8,.25,1);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
}
#kbd-drawer.open{transform:translateY(0)}
#kbd-handle{width:40px;height:4px;background:rgba(255,255,255,.18);border-radius:2px;margin:0 auto 10px}

/* input row */
.kd-inputs{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.kd-field{
  flex:1;background:#010810;border-radius:8px;padding:7px 10px;
  text-align:center;border:1px solid rgba(10,42,74,.8);transition:all .15s;
}
.kd-field.act-a{border-color:var(--blue);box-shadow:0 0 12px rgba(0,212,255,.25)}
.kd-field.act-b{border-color:var(--green);box-shadow:0 0 12px rgba(0,255,136,.25)}
.kd-lbl{font-size:8px;letter-spacing:2px;color:#336}
.kd-val{font-family:'Orbitron',monospace;font-size:20px;font-weight:700;color:var(--blue)}
.kd-val.b{color:var(--green)}
.kcur{display:inline-block;width:2px;height:18px;background:currentColor;animation:blink .7s infinite;vertical-align:middle;margin-left:1px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* op buttons */
.kd-ops{display:flex;gap:6px;margin-bottom:10px}
.kd-op{
  flex:1;padding:8px 0;border-radius:8px;border:1px solid rgba(10,42,74,.8);
  background:#010810;color:var(--orange);font-family:'Orbitron',monospace;
  font-size:16px;text-align:center;cursor:pointer;transition:all .12s;
}
.kd-op.sel{border-color:var(--orange);background:rgba(255,153,0,.15);box-shadow:0 0 10px rgba(255,153,0,.3)}

/* keys grid */
#kd-keys{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.kk{
  aspect-ratio:1;background:linear-gradient(145deg,#07192e,#020c18);
  border:1px solid rgba(0,80,140,.4);border-radius:10px;
  color:var(--blue);font-family:'Orbitron',monospace;font-size:18px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  position:relative;overflow:hidden;transition:all .1s;
  box-shadow:0 2px 8px rgba(0,0,0,.5),inset 0 1px 0 rgba(0,212,255,.06);
  -webkit-tap-highlight-color:transparent;
}
.kk:active,.kk.press{transform:scale(.89);background:rgba(0,212,255,.14);border-color:var(--blue);box-shadow:0 0 16px rgba(0,212,255,.5)}
.kk.k0{grid-column:span 2;aspect-ratio:auto;height:44px}
.kk.kbk{color:var(--pink);font-size:13px}
.kk.kbk:active{border-color:var(--pink);background:rgba(255,45,120,.1)}
.kk.kclr{grid-column:1/-1;aspect-ratio:auto;height:36px;font-size:10px;letter-spacing:2px;color:var(--orange);border-color:rgba(255,100,0,.2)}
.kk.kclr:active{border-color:var(--orange);background:rgba(255,153,0,.1)}
.kk.kcalc{
  grid-column:1/-1;aspect-ratio:auto;height:46px;
  font-size:12px;letter-spacing:3px;font-weight:900;
  color:#000;background:var(--blue);border-color:var(--blue);
}
.kk.kcalc:active{background:#00aacc}
.kk.kcalc.running{background:var(--orange);border-color:var(--orange);animation:calcblink .45s ease infinite alternate}
@keyframes calcblink{from{opacity:.7}to{opacity:1}}
.krip{position:absolute;width:50px;height:50px;background:rgba(0,212,255,.3);border-radius:50%;transform:scale(0);animation:rip .38s ease-out forwards;pointer-events:none}
@keyframes rip{to{transform:scale(3);opacity:0}}

/* ‚îÄ‚îÄ FAB buttons ‚îÄ‚îÄ */
.fab{
  position:absolute;right:16px;z-index:40;
  width:52px;height:52px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:22px;cursor:pointer;
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
  border:1px solid;transition:all .2s;
  box-shadow:0 4px 20px rgba(0,0,0,.4);
}
#btn-kbd{
  bottom:calc(16px + env(safe-area-inset-bottom,0px));
  background:rgba(0,212,255,.12);border-color:rgba(0,212,255,.4);color:var(--blue);
}
#btn-kbd:active{transform:scale(.92)}
#btn-exit{
  top:max(env(safe-area-inset-top,12px),12px);left:14px;
  width:36px;height:36px;font-size:16px;
  background:rgba(255,45,120,.12);border-color:rgba(255,45,120,.4);color:var(--pink);
  /* only on desktop AR */
  display:none;
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{
  position:absolute;left:50%;z-index:70;
  top:calc(max(env(safe-area-inset-top,14px),14px) + 38px);
  transform:translateX(-50%) translateY(-8px);
  background:rgba(0,10,24,.88);border:1px solid;border-radius:22px;
  padding:6px 18px;font-size:10px;letter-spacing:2px;
  opacity:0;transition:all .35s;pointer-events:none;white-space:nowrap;
  backdrop-filter:blur(10px);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DESKTOP VIEW
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#desktop-view{
  display:flex;flex-direction:column;
  width:100%;height:100%;background:var(--bg);
}
#titlebar{
  flex-shrink:0;text-align:center;
  padding:8px 0 4px;
  background:linear-gradient(180deg,#020e1c,transparent);
}
#titlebar h1{
  font-family:'Orbitron',monospace;font-size:15px;font-weight:900;
  letter-spacing:8px;color:var(--blue);
  text-shadow:0 0 20px var(--blue),0 0 60px rgba(0,212,255,.25);
}
#titlebar p{font-size:9px;letter-spacing:4px;color:rgba(0,212,255,.35);margin-top:2px}
/* desktop AR launch button */
#dt-ar-btn{
  position:absolute;top:10px;right:14px;
  padding:7px 14px;background:rgba(0,212,255,.1);
  border:1px solid rgba(0,212,255,.35);border-radius:20px;
  color:var(--blue);font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;
  cursor:pointer;z-index:99;backdrop-filter:blur(6px);
}
#wrapper{
  flex:1;display:flex;gap:0;overflow:hidden;padding:4px 8px 8px;
}
.box{background:rgba(3,15,30,.92);border:1px solid rgba(10,42,74,.8);border-radius:8px;padding:8px 10px}
.boxt{font-family:'Orbitron',monospace;font-size:8px;letter-spacing:3px;color:var(--blue);border-bottom:1px solid rgba(10,42,74,.8);padding-bottom:5px;margin-bottom:7px}
#controls{width:190px;min-width:190px;display:flex;flex-direction:column;gap:6px}
#rightpanel{width:190px;min-width:190px;display:flex;flex-direction:column;gap:6px}
#svgwrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;overflow:hidden}
#arch-svg{flex:1;width:100%;min-height:0}
#pipe-bar{width:98%;height:28px;display:flex;border-radius:6px;overflow:hidden;border:1px solid rgba(10,42,74,.8);flex-shrink:0}
.pstage{flex:1;display:flex;align-items:center;justify-content:center;font-family:'Orbitron',monospace;font-size:7px;letter-spacing:1px;color:#1a3a5a;border-right:1px solid rgba(10,42,74,.8);transition:all .3s}
.pstage:last-child{border-right:none}
.ps-if{background:rgba(0,212,255,.18);color:var(--blue);box-shadow:inset 0 0 10px rgba(0,212,255,.2)}
.ps-id{background:rgba(255,45,120,.18);color:var(--pink);box-shadow:inset 0 0 10px rgba(255,45,120,.2)}
.ps-ex{background:rgba(255,153,0,.18);color:var(--orange);box-shadow:inset 0 0 10px rgba(255,153,0,.2)}
.ps-mem{background:rgba(204,68,255,.18);color:var(--purple);box-shadow:inset 0 0 10px rgba(204,68,255,.2)}
.ps-wb{background:rgba(0,255,136,.18);color:var(--green);box-shadow:inset 0 0 10px rgba(0,255,136,.2)}
.inp-row{display:flex;gap:5px;align-items:center;margin-bottom:6px}
.inp-f{flex:1;background:#010810;border-radius:5px;padding:5px 6px;text-align:center;border:1px solid rgba(10,42,74,.8);cursor:pointer;transition:all .15s}
.inp-f.act-a{border-color:var(--blue);box-shadow:0 0 10px rgba(0,212,255,.3)}
.inp-f.act-b{border-color:var(--green);box-shadow:0 0 10px rgba(0,255,136,.3)}
.inlbl{font-size:7px;letter-spacing:2px;color:#224}
.inval{font-family:'Orbitron',monospace;font-size:20px;font-weight:700;color:var(--blue)}
.inval.b{color:var(--green)}
.cur{display:inline-block;width:2px;height:18px;background:var(--blue);animation:blink .7s infinite;vertical-align:middle}
.cur.b{background:var(--green)}
.ops{display:flex;gap:4px}
.opb{flex:1;padding:4px 0;border-radius:4px;border:1px solid rgba(10,42,74,.8);background:#010810;color:var(--orange);font-family:'Orbitron',monospace;font-size:13px;cursor:pointer;transition:all .15s;text-align:center}
.opb.sel{border-color:var(--orange);background:rgba(255,153,0,.15);box-shadow:0 0 8px rgba(255,153,0,.3)}
#dtkb{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.dtk{aspect-ratio:1;background:linear-gradient(145deg,#07192e,#020c18);border:1px solid #0a2a4a;border-radius:7px;color:var(--blue);font-family:'Orbitron',monospace;font-size:15px;font-weight:700;cursor:pointer;transition:all .1s;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
.dtk:hover{border-color:var(--blue)}
.dtk:active,.dtk.press{transform:scale(.91);background:rgba(0,212,255,.12);border-color:var(--blue)}
.dtk.zero{grid-column:span 2;aspect-ratio:auto;height:38px}
.dtk.kback{color:var(--pink);font-size:11px}
.dtk.kclr{grid-column:1/-1;aspect-ratio:auto;height:34px;font-size:9px;letter-spacing:2px;color:var(--orange)}
#calc-btn{width:100%;padding:9px;background:linear-gradient(135deg,#003366,#001a33);border:1px solid var(--blue);border-radius:7px;color:var(--blue);font-family:'Orbitron',monospace;font-size:10px;font-weight:700;letter-spacing:4px;cursor:pointer;transition:all .2s;box-shadow:0 0 14px rgba(0,212,255,.2)}
#calc-btn:hover{box-shadow:0 0 24px rgba(0,212,255,.5)}
#calc-btn:disabled{opacity:.3;cursor:not-allowed}
#calc-btn.running{animation:cpulse .45s ease infinite alternate}
@keyframes cpulse{from{box-shadow:0 0 14px rgba(0,212,255,.3)}to{box-shadow:0 0 36px rgba(0,212,255,.9)}}
#step-msg{font-size:8px;letter-spacing:2px;text-align:center;min-height:14px;color:#336;transition:color .3s}
.cstep{padding:4px 0;border-bottom:1px solid #0a1a2a;font-size:8px;transition:all .3s;color:#1a3a5a}
.cstep-t{font-family:'Orbitron',monospace;font-size:7px;letter-spacing:2px}
.cstep.act-if .cstep-t{color:var(--blue)} .cstep.act-id .cstep-t{color:var(--pink)}
.cstep.act-ex .cstep-t{color:var(--orange)} .cstep.act-wb .cstep-t{color:var(--green)}
.cstep.act-if,.cstep.act-id,.cstep.act-ex,.cstep.act-wb{color:#aaa}
#res-big{font-family:'Orbitron',monospace;font-size:18px;font-weight:900;color:var(--yellow);text-shadow:0 0 16px rgba(255,255,0,.6);text-align:center;min-height:26px}
#res-bin{font-size:8px;color:#336688;letter-spacing:2px;text-align:center;min-height:14px}
#res-hex{font-size:8px;color:#224;letter-spacing:2px;text-align:center;min-height:14px}
#log-body{height:120px;overflow-y:auto;font-size:8px;line-height:1.9}
#log-body::-webkit-scrollbar{width:3px}
#log-body::-webkit-scrollbar-thumb{background:rgba(10,42,74,.8);border-radius:2px}
.lr{color:var(--blue)}.lc{color:var(--pink)}.lg{color:var(--green)}.lu{color:var(--orange)}.lx{color:var(--yellow);font-weight:bold}.ls{color:#244}
/* tog buttons */
.tog-ab{flex:1;padding:4px;border-radius:5px;border:1px solid rgba(10,42,74,.8);background:#010810;color:#336;font-size:8px;letter-spacing:2px;text-align:center;cursor:pointer;transition:all .15s}
.tog-ab.act-a{border-color:var(--blue);background:rgba(0,212,255,.1);color:var(--blue)}
.tog-ab.act-b{border-color:var(--green);background:rgba(0,255,136,.1);color:var(--green)}
/* drip ripple shared */
.drip{position:absolute;width:40px;height:40px;background:rgba(0,212,255,.3);border-radius:50%;transform:scale(0);animation:rip .38s ease-out forwards;pointer-events:none}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AR VIEW (mobile default) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="ar-view">
  <!-- ‚îÄ‚îÄ FONDO ESPACIAL ‚îÄ‚îÄ -->
  <canvas id="space-canvas"></canvas>
  <div id="nebula"></div>
  <div id="holo-grid"></div>
  <div id="scanlines"></div>
  <div id="vignette"></div>

  <!-- HUD -->
  <div id="hud">
    <div id="hud-title">ARQCOMP AR</div>
    <div id="gyro-indicator">
      <span id="gyro-icon">‚ü≥</span>
      <div id="gyro-bar"><div id="gyro-fill"></div></div>
      <span id="gyro-lbl">GIROSCOPIO</span>
    </div>
  </div>

  <!-- exit (desktop AR) -->
  <button class="fab" id="btn-exit" onclick="exitAR()">‚úï</button>

  <!-- Connector canvas -->
  <canvas id="conn-canvas"></canvas>

  <!-- 3D Cube Scene -->
  <div id="ar-scene">
    <!-- RAM -->
    <div class="arc" id="arc-ram" onclick="openInspect('ram')">
      <div class="cube3 cube-ram">
        <div class="face f" style="color:var(--blue)">RAM</div>
        <div class="face bk"></div>
        <div class="face r"></div>
        <div class="face l"></div>
        <div class="face t"></div>
        <div class="face bo"></div>
      </div>
      <div class="cube-glow"></div>
      <div class="cube-name" style="color:var(--blue)">RAM</div>
      <div class="cube-sub" style="color:rgba(0,212,255,.5)">MEMORIA PRINCIPAL</div>
      <div class="cube-hint" style="color:var(--blue)">‚ñº TAP</div>
    </div>

    <!-- CACH√â -->
    <div class="arc" id="arc-cache" onclick="openInspect('cache')">
      <div class="cube3 cube-cache">
        <div class="face f" style="color:var(--pink)">CACH√â</div>
        <div class="face bk"></div>
        <div class="face r"></div>
        <div class="face l"></div>
        <div class="face t"></div>
        <div class="face bo"></div>
      </div>
      <div class="cube-glow"></div>
      <div class="cube-name" style="color:var(--pink)">CACH√â</div>
      <div class="cube-sub" style="color:rgba(255,45,120,.5)">L1 / L2 / L3</div>
      <div class="cube-hint" style="color:var(--pink)">‚ñº TAP</div>
    </div>

    <!-- REGISTRO -->
    <div class="arc" id="arc-reg" onclick="openInspect('reg')">
      <div class="cube3 cube-reg">
        <div class="face f" style="color:var(--green);font-size:7px">REG</div>
        <div class="face bk"></div>
        <div class="face r"></div>
        <div class="face l"></div>
        <div class="face t"></div>
        <div class="face bo"></div>
      </div>
      <div class="cube-glow"></div>
      <div class="cube-name" style="color:var(--green)">REGISTRO</div>
      <div class="cube-sub" style="color:rgba(0,255,136,.5)">BANCO REG</div>
      <div class="cube-hint" style="color:var(--green)">‚ñº TAP</div>
    </div>

    <!-- ULA -->
    <div class="arc" id="arc-ula" onclick="openInspect('ula')">
      <div class="cube3 cube-ula">
        <div class="face f" style="color:var(--orange)">ULA</div>
        <div class="face bk"></div>
        <div class="face r"></div>
        <div class="face l"></div>
        <div class="face t"></div>
        <div class="face bo"></div>
      </div>
      <div class="cube-glow"></div>
      <div class="cube-name" style="color:var(--orange)">ULA</div>
      <div class="cube-sub" style="color:rgba(255,153,0,.5)">ARITM√âTICA</div>
      <div class="cube-hint" style="color:var(--orange)">‚ñº TAP</div>
    </div>
  </div>

  <!-- Bit layer -->
  <div id="bit-layer"></div>

  <!-- Step banner -->
  <div id="step-banner"></div>

  <!-- Inspect panel -->
  <div id="inspect">
    <div id="inspect-handle"></div>
    <div id="inspect-close" onclick="closeInspect()">‚úï</div>
    <div id="inspect-title"></div>
    <div id="inspect-sub"></div>
    <div id="inspect-status"></div>
    <div id="inspect-rows"></div>
  </div>

  <!-- Keyboard drawer -->
  <div id="kbd-drawer">
    <div id="kbd-handle"></div>
    <div style="display:flex;gap:6px;margin-bottom:8px">
      <div id="kd-tA" class="tog-ab act-a" onclick="arSetActive('A')">VALOR A</div>
      <div id="kd-tB" class="tog-ab" onclick="arSetActive('B')">VALOR B</div>
    </div>
    <div class="kd-inputs">
      <div class="kd-field act-a" id="kd-fa">
        <div class="kd-lbl">A</div>
        <div class="kd-val" id="kd-va">0<span class="kcur" id="kd-ca" style="color:var(--blue)"></span></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <div class="kd-op sel" id="kop+">+</div>
        <div class="kd-op"     id="kop-">‚àí</div>
        <div class="kd-op"     id="kop*">√ó</div>
      </div>
      <div class="kd-field" id="kd-fb">
        <div class="kd-lbl">B</div>
        <div class="kd-val b" id="kd-vb">0<span class="kcur" id="kd-cb" style="color:var(--green);display:none"></span></div>
      </div>
    </div>
    <div id="kd-keys">
      <button class="kk" data-k="7">7</button><button class="kk" data-k="8">8</button><button class="kk" data-k="9">9</button>
      <button class="kk" data-k="4">4</button><button class="kk" data-k="5">5</button><button class="kk" data-k="6">6</button>
      <button class="kk" data-k="1">1</button><button class="kk" data-k="2">2</button><button class="kk" data-k="3">3</button>
      <button class="kk k0"   data-k="0">0</button>
      <button class="kk kbk"  data-k="back">‚å´</button>
      <button class="kk kclr" data-k="clr">CLR</button>
      <button class="kk kcalc" id="kd-calc" onclick="arCalc()">‚ö° CALCULAR</button>
    </div>
  </div>

  <!-- FAB keyboard -->
  <button class="fab" id="btn-kbd" onclick="toggleKbd()">‚å®</button>

  <!-- Toast -->
  <div id="toast"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DESKTOP VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="desktop-view">
  <div id="titlebar" style="position:relative">
    <h1>ARQUITECTURA DE COMPUTADORAS</h1>
    <p>SIMULACI√ìN INMERSIVA ¬∑ ABRE EN CELULAR PARA EXPERIENCIA AR</p>
    <div id="dt-ar-btn" onclick="launchAR()">üì∑ VISTA AR</div>
  </div>
  <div id="wrapper">
    <!-- LEFT -->
    <div id="controls">
      <div class="box">
        <div class="boxt">INGRESO DE VALORES</div>
        <div style="display:flex;gap:4px;margin-bottom:6px">
          <div class="tog-ab act-a" id="dt-tA" onclick="dtSetActive('A')">VALOR A</div>
          <div class="tog-ab"       id="dt-tB" onclick="dtSetActive('B')">VALOR B</div>
        </div>
        <div class="inp-row">
          <div class="inp-f act-a" id="dt-fa" onclick="dtSetActive('A')">
            <div class="inlbl">A</div>
            <div class="inval" id="dt-va">0<span class="cur" id="dt-ca"></span></div>
          </div>
          <div class="ops" style="flex-direction:column;gap:3px">
            <div class="opb sel" id="dt-op+">+</div>
            <div class="opb"     id="dt-op-">‚àí</div>
            <div class="opb"     id="dt-op*">√ó</div>
          </div>
          <div class="inp-f" id="dt-fb" onclick="dtSetActive('B')">
            <div class="inlbl">B</div>
            <div class="inval b" id="dt-vb">0<span class="cur b" id="dt-cb" style="display:none"></span></div>
          </div>
        </div>
      </div>
      <div class="box">
        <div class="boxt">TECLADO NUM√âRICO</div>
        <div id="dtkb">
          <button class="dtk" data-k="7">7</button><button class="dtk" data-k="8">8</button><button class="dtk" data-k="9">9</button>
          <button class="dtk" data-k="4">4</button><button class="dtk" data-k="5">5</button><button class="dtk" data-k="6">6</button>
          <button class="dtk" data-k="1">1</button><button class="dtk" data-k="2">2</button><button class="dtk" data-k="3">3</button>
          <button class="dtk zero" data-k="0">0</button>
          <button class="dtk kback" data-k="back">‚å´</button>
          <button class="dtk kclr" data-k="clr">CLR</button>
        </div>
      </div>
      <button id="calc-btn" onclick="runSim()">‚ö° CALCULAR</button>
      <div id="step-msg"></div>
      <div class="box" style="flex:1">
        <div class="boxt">CICLO CPU</div>
        <div class="cstep" id="cs-if"><div class="cstep-t">‚ë† FETCH</div><div>Leer instrucci√≥n de RAM</div></div>
        <div class="cstep" id="cs-id"><div class="cstep-t">‚ë° DECODE + CACHE</div><div>Cach√© carga operandos</div></div>
        <div class="cstep" id="cs-ex"><div class="cstep-t">‚ë¢ EXECUTE</div><div>ULA procesa la operaci√≥n</div></div>
        <div class="cstep" id="cs-wb"><div class="cstep-t">‚ë£ WRITEBACK</div><div>Resultado a Registro+RAM</div></div>
      </div>
    </div>
    <!-- CENTER SVG -->
    <div id="svgwrap">
      <svg id="arch-svg" viewBox="0 0 920 520" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
        <defs>
          <radialGradient id="bgr" cx="50%" cy="50%" r="65%"><stop offset="0%" stop-color="#06182e"/><stop offset="100%" stop-color="#010c18"/></radialGradient>
          <linearGradient id="rt"  x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#0e3060"/><stop offset="100%" stop-color="#071a3a"/></linearGradient>
          <linearGradient id="rl"  x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#051225"/><stop offset="100%" stop-color="#0e3060"/></linearGradient>
          <linearGradient id="rf"  x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#123880"/><stop offset="100%" stop-color="#091e4a"/></linearGradient>
          <linearGradient id="ct"  x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#5a1240"/><stop offset="100%" stop-color="#350828"/></linearGradient>
          <linearGradient id="cl"  x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#25061a"/><stop offset="100%" stop-color="#5a1240"/></linearGradient>
          <linearGradient id="cf"  x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#721550"/><stop offset="100%" stop-color="#440d30"/></linearGradient>
          <linearGradient id="egt" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#0e5028"/><stop offset="100%" stop-color="#073018"/></linearGradient>
          <linearGradient id="egl" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#052010"/><stop offset="100%" stop-color="#0e5028"/></linearGradient>
          <linearGradient id="egf" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#126632"/><stop offset="100%" stop-color="#0a3c1e"/></linearGradient>
          <linearGradient id="utt" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#5a3010"/><stop offset="100%" stop-color="#351808"/></linearGradient>
          <linearGradient id="ull" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#251005"/><stop offset="100%" stop-color="#5a3010"/></linearGradient>
          <linearGradient id="uff" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#723c14"/><stop offset="100%" stop-color="#44220a"/></linearGradient>
          <filter id="fsm" x="-40%" y="-40%" width="180%" height="180%"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
          <clipPath id="cpR"><rect x="125" y="205" width="180" height="155"/></clipPath>
          <clipPath id="cpC"><rect x="380" y="32"  width="180" height="155"/></clipPath>
          <clipPath id="cpG"><rect x="640" y="205" width="180" height="155"/></clipPath>
          <clipPath id="cpU"><rect x="380" y="295" width="180" height="175"/></clipPath>
          <marker id="aB" markerWidth="7" markerHeight="7" refX="3.5" refY="3.5" orient="auto"><polygon points="0,0 7,3.5 0,7" fill="#00d4ff"/></marker>
          <marker id="aP" markerWidth="7" markerHeight="7" refX="3.5" refY="3.5" orient="auto"><polygon points="0,0 7,3.5 0,7" fill="#ff2d78"/></marker>
          <marker id="aG" markerWidth="7" markerHeight="7" refX="3.5" refY="3.5" orient="auto"><polygon points="0,0 7,3.5 0,7" fill="#00ff88"/></marker>
          <marker id="aO" markerWidth="7" markerHeight="7" refX="3.5" refY="3.5" orient="auto"><polygon points="0,0 7,3.5 0,7" fill="#ff9900"/></marker>
        </defs>
        <rect width="920" height="520" fill="url(#bgr)"/>
        <pattern id="dots" x="0" y="0" width="30" height="30" patternUnits="userSpaceOnUse"><circle cx="15" cy="15" r=".7" fill="#0a2040" opacity=".6"/></pattern>
        <rect width="920" height="520" fill="url(#dots)"/>
        <path id="path-rc"   d="M 305,260 C 340,200 355,155 380,120" stroke="#00d4ff" stroke-width="2" fill="none" stroke-dasharray="8,5" opacity="0" marker-end="url(#aB)"/>
        <path id="path-cr"   d="M 560,120 C 600,155 620,200 640,260" stroke="#ff2d78"  stroke-width="2" fill="none" stroke-dasharray="8,5" opacity="0" marker-end="url(#aP)"/>
        <path id="path-ru"   d="M 640,300 C 620,315 600,325 560,335" stroke="#00ff88"  stroke-width="2" fill="none" stroke-dasharray="8,5" opacity="0" marker-end="url(#aG)"/>
        <path id="path-ur"   d="M 540,295 C 578,280 608,275 640,280" stroke="#ff9900"  stroke-width="2.5" fill="none" stroke-dasharray="6,4" opacity="0" marker-end="url(#aO)"/>
        <path id="path-rram" d="M 660,360 C 560,400 420,410 305,330" stroke="#00ff88"  stroke-width="1.8" fill="none" stroke-dasharray="6,4" opacity="0" marker-end="url(#aG)"/>
        <g id="bit-layer-svg"></g>
        <text id="lbl-rc"   x="330" y="185" fill="#00d4ff" font-size="10" font-family="'Share Tech Mono',monospace" opacity="0" transform="rotate(-52,330,185)">‚ë† FETCH</text>
        <text id="lbl-cr"   x="596" y="183" fill="#ff2d78"  font-size="10" font-family="'Share Tech Mono',monospace" opacity="0" transform="rotate(52,596,183)">‚ë° LOAD</text>
        <text id="lbl-ru"   x="588" y="323" fill="#00ff88"  font-size="10" font-family="'Share Tech Mono',monospace" opacity="0">‚ë¢ EXEC</text>
        <text id="lbl-ur"   x="575" y="269" fill="#ff9900"  font-size="10" font-family="'Share Tech Mono',monospace" opacity="0">‚ë£ WB</text>
        <text id="lbl-rram" x="440" y="415" fill="#00ff88"  font-size="10" font-family="'Share Tech Mono',monospace" opacity="0">‚ë§ STORE</text>
        <!-- RAM -->
        <g id="cube-ram">
          <polygon points="80,140 230,90 310,140 160,190" fill="url(#rt)" stroke="#00d4ff" stroke-width="1.5"/>
          <polygon points="80,140 80,310 160,360 160,190" fill="url(#rl)" stroke="#005a99" stroke-width="1.5"/>
          <polygon points="160,190 310,140 310,310 160,360" fill="url(#rf)" stroke="#00d4ff" stroke-width="1.5"/>
          <g clip-path="url(#cpR)">
            <rect x="125" y="205" width="180" height="18" fill="rgba(0,212,255,.08)"/>
            <text x="215" y="218" text-anchor="middle" fill="#00d4ff" font-size="9" font-family="Orbitron" letter-spacing="2">MEMORIA RAM</text>
            <text x="135" y="240" fill="#0066aa" font-size="9" font-family="'Share Tech Mono',monospace">ADDR    HEX   DEC</text>
            <line x1="133" y1="244" x2="303" y2="244" stroke="#0a2a4a" stroke-width=".8"/>
            <text x="135" y="257" fill="#00d4ff" font-size="10" font-family="'Share Tech Mono',monospace">0x1000  <tspan id="ram-hex-a">0A</tspan>  A=<tspan id="ram-dec-a">10</tspan></text>
            <text x="135" y="272" fill="#00d4ff" font-size="10" font-family="'Share Tech Mono',monospace">0x1004  <tspan id="ram-hex-b">05</tspan>  B=<tspan id="ram-dec-b">5</tspan></text>
            <text x="135" y="287" fill="#00ff88" font-size="10" font-family="'Share Tech Mono',monospace">0x1008  <tspan id="ram-hex-c">??</tspan>  C=<tspan id="ram-dec-c">?</tspan></text>
            <text x="135" y="302" fill="#082244" font-size="9" font-family="'Share Tech Mono',monospace">0x100C  -- idle</text>
            <rect x="127" y="250" width="3" height="9" fill="#00d4ff" opacity="0"><animate attributeName="opacity" values="0;1;0" dur="1.2s" repeatCount="indefinite"/></rect>
          </g>
          <text x="195" y="78"  text-anchor="middle" fill="#00d4ff" font-size="13" font-family="Orbitron" font-weight="700" letter-spacing="4" filter="url(#fsm)">RAM</text>
          <text x="195" y="92"  text-anchor="middle" fill="#005a99" font-size="8" font-family="'Share Tech Mono',monospace" letter-spacing="2">MEMORIA PRINCIPAL</text>
          <ellipse id="pulse-ram" cx="195" cy="265" rx="0" ry="0" fill="none" stroke="#00d4ff" stroke-width="1.5" opacity="0"/>
        </g>
        <!-- CACHE -->
        <g id="cube-cache">
          <polygon points="340,28 490,-22 570,28 420,78" fill="url(#ct)" stroke="#ff2d78" stroke-width="1.5"/>
          <polygon points="340,28 340,198 420,248 420,78" fill="url(#cl)" stroke="#aa1155" stroke-width="1.5"/>
          <polygon points="420,78 570,28 570,198 420,248" fill="url(#cf)" stroke="#ff2d78" stroke-width="1.5"/>
          <g clip-path="url(#cpC)">
            <rect x="380" y="32" width="180" height="18" fill="rgba(255,45,120,.08)"/>
            <text x="470" y="45" text-anchor="middle" fill="#ff2d78" font-size="9" font-family="Orbitron" letter-spacing="2">CACH√â L1/L2</text>
            <text x="390" y="67" fill="#881144" font-size="9" font-family="'Share Tech Mono',monospace">NIVEL  DATO   ESTADO</text>
            <line x1="388" y1="71" x2="558" y2="71" stroke="#2a0a1a" stroke-width=".8"/>
            <text x="390" y="84"  fill="#ff2d78" font-size="10" font-family="'Share Tech Mono',monospace">L1:  A=<tspan id="ca-a">??</tspan>  <tspan id="ca-hit-a" fill="#244">----</tspan></text>
            <text x="390" y="99"  fill="#ff2d78" font-size="10" font-family="'Share Tech Mono',monospace">L1:  B=<tspan id="ca-b">??</tspan>  <tspan id="ca-hit-b" fill="#244">----</tspan></text>
            <text x="390" y="114" fill="#ff5599" font-size="10" font-family="'Share Tech Mono',monospace">L2:  <tspan id="ca-l2">idle</tspan></text>
            <text x="390" y="133" fill="#00ff88" font-size="11" font-weight="bold" font-family="'Share Tech Mono',monospace"><tspan id="ca-status">STANDBY</tspan></text>
            <text x="390" y="148" fill="#441133" font-size="9" font-family="'Share Tech Mono',monospace">lat: <tspan id="ca-lat">~2ns</tspan></text>
          </g>
          <text x="455" y="-34" text-anchor="middle" fill="#ff2d78" font-size="13" font-family="Orbitron" font-weight="700" letter-spacing="4" filter="url(#fsm)">CACH√â</text>
          <text x="455" y="-20" text-anchor="middle" fill="#aa1155" font-size="8" font-family="'Share Tech Mono',monospace" letter-spacing="2">L1 / L2 / L3</text>
          <ellipse id="pulse-cache" cx="455" cy="138" rx="0" ry="0" fill="none" stroke="#ff2d78" stroke-width="1.5" opacity="0"/>
        </g>
        <!-- REG -->
        <g id="cube-reg">
          <polygon points="600,140 750,90 830,140 680,190" fill="url(#egt)" stroke="#00ff88" stroke-width="1.5"/>
          <polygon points="600,140 600,310 680,360 680,190" fill="url(#egl)" stroke="#00aa44" stroke-width="1.5"/>
          <polygon points="680,190 830,140 830,310 680,360" fill="url(#egf)" stroke="#00ff88" stroke-width="1.5"/>
          <g clip-path="url(#cpG)">
            <rect x="640" y="205" width="180" height="18" fill="rgba(0,255,136,.07)"/>
            <text x="730" y="218" text-anchor="middle" fill="#00ff88" font-size="9" font-family="Orbitron" letter-spacing="2">REGISTROS</text>
            <text x="650" y="240" fill="#115533" font-size="9" font-family="'Share Tech Mono',monospace">REG  BIN       DEC</text>
            <line x1="648" y1="244" x2="818" y2="244" stroke="#0a2a18" stroke-width=".8"/>
            <text x="650" y="257" fill="#00ff88" font-size="10" font-family="'Share Tech Mono',monospace">R1: <tspan id="rg-r1">00001010</tspan> <tspan id="rg-d1">10</tspan></text>
            <text x="650" y="272" fill="#00ff88" font-size="10" font-family="'Share Tech Mono',monospace">R2: <tspan id="rg-r2">00000101</tspan> <tspan id="rg-d2">5</tspan></text>
            <text x="650" y="287" fill="#ffff00" font-size="10" font-family="'Share Tech Mono',monospace">R3: <tspan id="rg-r3">????????</tspan> <tspan id="rg-d3">?</tspan></text>
            <text x="650" y="302" fill="#113322" font-size="9" font-family="'Share Tech Mono',monospace">PC: <tspan id="rg-pc">0x2000</tspan></text>
            <text x="650" y="315" fill="#113322" font-size="9" font-family="'Share Tech Mono',monospace">IR: <tspan id="rg-ir">NOP</tspan></text>
          </g>
          <text x="715" y="78"  text-anchor="middle" fill="#00ff88" font-size="13" font-family="Orbitron" font-weight="700" letter-spacing="4" filter="url(#fsm)">REGISTRO</text>
          <text x="715" y="92"  text-anchor="middle" fill="#00aa44" font-size="8" font-family="'Share Tech Mono',monospace" letter-spacing="2">BANCO DE REGISTROS</text>
          <ellipse id="pulse-reg" cx="715" cy="268" rx="0" ry="0" fill="none" stroke="#00ff88" stroke-width="1.5" opacity="0"/>
        </g>
        <!-- ULA -->
        <g id="cube-ula">
          <polygon points="340,298 490,248 570,298 420,348" fill="url(#utt)" stroke="#ff9900" stroke-width="1.5"/>
          <polygon points="340,298 340,468 420,518 420,348" fill="url(#ull)" stroke="#aa6600" stroke-width="1.5"/>
          <polygon points="420,348 570,298 570,468 420,518" fill="url(#uff)" stroke="#ff9900" stroke-width="1.5"/>
          <g clip-path="url(#cpU)">
            <rect x="380" y="295" width="180" height="18" fill="rgba(255,153,0,.08)"/>
            <text x="470" y="308" text-anchor="middle" fill="#ff9900" font-size="9" font-family="Orbitron" letter-spacing="2">ULA / ALU</text>
            <text x="390" y="330" fill="#663300" font-size="9" font-family="'Share Tech Mono',monospace">ENTRADA A:</text>
            <text x="390" y="343" fill="#ff9900" font-size="10" font-family="'Share Tech Mono',monospace"><tspan id="ula-a">00000000</tspan> (<tspan id="ula-da">0</tspan>)</text>
            <text x="390" y="360" fill="#663300" font-size="9" font-family="'Share Tech Mono',monospace">ENTRADA B:</text>
            <text x="390" y="373" fill="#ff9900" font-size="10" font-family="'Share Tech Mono',monospace"><tspan id="ula-b">00000000</tspan> (<tspan id="ula-db">0</tspan>)</text>
            <line x1="388" y1="379" x2="558" y2="379" stroke="#553300" stroke-width=".8"/>
            <text x="390" y="394" fill="#ffcc44" font-size="10" font-family="'Share Tech Mono',monospace">OP: <tspan id="ula-op">---</tspan></text>
            <text x="390" y="410" fill="#ffff00" font-size="11" font-weight="bold" font-family="'Share Tech Mono',monospace">OUT: <tspan id="ula-out">????????</tspan></text>
            <text x="390" y="426" fill="#00ff88" font-size="10" font-family="'Share Tech Mono',monospace">DEC: <tspan id="ula-res">?</tspan></text>
            <text x="390" y="441" fill="#442200" font-size="9" font-family="'Share Tech Mono',monospace">FLAGS: <tspan id="ula-flags">Z=? C=? N=?</tspan></text>
            <text id="ula-plus" x="540" y="385" fill="#ff9900" font-size="22" font-family="Orbitron" font-weight="900" opacity=".3"><animate attributeName="opacity" values=".2;.9;.2" dur=".8s" repeatCount="indefinite"/></text>
          </g>
          <text x="455" y="237" text-anchor="middle" fill="#ff9900" font-size="13" font-family="Orbitron" font-weight="700" letter-spacing="4" filter="url(#fsm)">ULA</text>
          <text x="455" y="251" text-anchor="middle" fill="#aa6600" font-size="8" font-family="'Share Tech Mono',monospace" letter-spacing="2">UNIDAD L√ìGICO ARITM√âTICA</text>
          <ellipse id="pulse-ula" cx="455" cy="400" rx="0" ry="0" fill="none" stroke="#ff9900" stroke-width="1.5" opacity="0"/>
        </g>
        <text id="center-label" x="460" y="228" text-anchor="middle" fill="#1a3a5a" font-size="13" font-family="Orbitron" font-weight="700" letter-spacing="2">A + B = ?</text>
      </svg>
      <div id="pipe-bar">
        <div class="pstage" id="ps-if">IF</div><div class="pstage" id="ps-id">ID</div>
        <div class="pstage" id="ps-ex">EX</div><div class="pstage" id="ps-mem">MEM</div>
        <div class="pstage" id="ps-wb">WB</div>
      </div>
    </div>
    <!-- RIGHT -->
    <div id="rightpanel">
      <div class="box" style="text-align:center">
        <div class="boxt">RESULTADO</div>
        <div id="res-big">‚Äî</div><div id="res-bin"></div><div id="res-hex"></div>
      </div>
      <div class="box" style="flex:1">
        <div class="boxt">LOG DEL SISTEMA</div>
        <div id="log-body"></div>
      </div>
      <div class="box">
        <div class="boxt">JERARQU√çA</div>
        <div style="font-size:8px;line-height:2.1">
          <div id="hie-reg"   style="color:#1a3a5a;transition:all .3s">‚ñ∂ REGISTRO  &lt;1 ns</div>
          <div id="hie-cache" style="color:#1a3a5a;transition:all .3s">‚ñ∂ CACH√â L1  ~2 ns</div>
          <div id="hie-ram"   style="color:#1a3a5a;transition:all .3s">‚ñ∂ RAM       ~100 ns</div>
          <div style="color:#1a3a5a">‚ñ∂ SSD       ~100 Œºs</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let vA='0',vB='0',activeIn='A',selOp='+',running=false,arMode=false;
let simState={
  ram:{hexA:'0A',hexB:'05',hexC:'??',decA:10,decB:5,decC:'?'},
  cache:{a:'??',b:'??',hitA:'----',hitB:'----',status:'STANDBY',lat:'~2ns'},
  reg:{r1:'00001010',r2:'00000101',r3:'????????',d1:10,d2:5,d3:'?',pc:'0x2000',ir:'NOP'},
  ula:{a:'00000000',da:0,b:'00000000',db:0,op:'---',out:'????????',res:'?',flags:'Z=? C=? N=?'},
  result:{eq:'‚Äî',bin:'',hex:''},
  step:''
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $=id=>document.getElementById(id);
const sv=(id,v)=>{const e=$(id);if(e)e.textContent=v};
const wait=ms=>new Promise(r=>setTimeout(r,ms));
const isMobile=/Mobi|Android|iPhone|iPad/i.test(navigator.userAgent);
function toBin(n,b=8){n=((n%(1<<b))+(1<<b))%(1<<b);return n.toString(2).padStart(b,'0').slice(-b)}
function toHex(n,d=2){return(((n%256)+256)%256).toString(16).toUpperCase().padStart(d,'0')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOBILE DETECTION ‚Üí auto-show AR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if(isMobile){
  document.body.classList.add('is-mobile');
  startAR();
}

// ‚îÄ‚îÄ SPACE BACKGROUND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initSpaceBackground(){
  const canvas=$('space-canvas');
  if(!canvas)return;
  const ctx=canvas.getContext('2d');
  let W,H,stars=[];

  function resize(){
    W=canvas.width=window.innerWidth;
    H=canvas.height=window.innerHeight;
    stars=[];
    // Layer 1: tiny distant stars
    for(let i=0;i<220;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*.9+.15,speed:Math.random()*.025+.005,tw:Math.random()*Math.PI*2,twS:Math.random()*.025+.008,col:'#ffffff',layer:0});
    // Layer 2: mid colored stars
    for(let i=0;i<60;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.3+.5,speed:Math.random()*.04+.01,tw:Math.random()*Math.PI*2,twS:Math.random()*.035+.01,col:['#00d4ff','#ff2d78','#00ff88','#cc44ff'][Math.floor(Math.random()*4)],layer:1});
    // Layer 3: bright foreground stars with glow
    for(let i=0;i<18;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*2+1.2,speed:Math.random()*.06+.02,tw:Math.random()*Math.PI*2,twS:Math.random()*.04+.015,col:['#00d4ff','#ffffff','#ff2d78'][Math.floor(Math.random()*3)],layer:2});
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    // Deep space gradient base
    const bg=ctx.createRadialGradient(W*.4,H*.35,0,W*.5,H*.5,Math.max(W,H)*.85);
    bg.addColorStop(0,'#06182e');
    bg.addColorStop(.5,'#030e1c');
    bg.addColorStop(1,'#01070f');
    ctx.fillStyle=bg;ctx.fillRect(0,0,W,H);

    stars.forEach(s=>{
      s.tw+=s.twS;
      const brightness=0.3+0.7*Math.abs(Math.sin(s.tw));
      const alpha=brightness*(s.layer===0?.6:s.layer===1?.85:1);
      // glow halo for brighter stars
      if(s.layer>=1){
        const gr=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,s.r*5);
        gr.addColorStop(0,s.col+(s.layer===2?'55':'33'));
        gr.addColorStop(1,'transparent');
        ctx.beginPath();ctx.arc(s.x,s.y,s.r*5,0,Math.PI*2);
        ctx.fillStyle=gr;ctx.globalAlpha=alpha*.5;ctx.fill();
      }
      ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fillStyle=s.col;ctx.globalAlpha=alpha;ctx.fill();
    });
    ctx.globalAlpha=1;
    requestAnimationFrame(draw);
  }

  window.addEventListener('resize',resize);
  resize();
  draw();
}

// ‚îÄ‚îÄ GYROSCOPE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let gyroX=0,gyroY=0,gyroTX=0,gyroTY=0,gyroActive=false;
const GYRO_PX=28; // max parallax shift in px

function initGyroscope(){
  function attach(){
    window.addEventListener('deviceorientation',e=>{
      if(e.beta===null&&e.gamma===null)return;
      gyroActive=true;
      // beta=front-back tilt, gamma=left-right
      // Normalize around natural holding angle (~50¬∞ beta)
      const gx=Math.max(-45,Math.min(45,e.gamma||0));
      const gy=Math.max(-35,Math.min(35,(e.beta||50)-50));
      gyroTX=(gx/45)*GYRO_PX;
      gyroTY=(gy/35)*GYRO_PX;
      // update HUD
      const pct=Math.min(100,(Math.abs(gx)+Math.abs(gy))/80*100);
      const fill=$('gyro-fill');if(fill)fill.style.width=pct+'%';
      const icon=$('gyro-icon');if(icon)icon.style.transform=`rotate(${gx*1.5}deg)`;
      const lbl=$('gyro-lbl');if(lbl)lbl.textContent='ACTIVO';
    },true);
  }
  // iOS 13+ requires permission request triggered by user gesture
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
    // Queue permission request on first user touch
    document.addEventListener('touchstart',function reqPerm(){
      DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')attach();}).catch(()=>{});
      document.removeEventListener('touchstart',reqPerm);
    },{once:true});
  } else {
    attach();
  }
}

// Smooth gyro parallax loop
function gyroParallaxLoop(){
  gyroX+=(gyroTX-gyroX)*.09;
  gyroY+=(gyroTY-gyroY)*.09;
  const scene=$('ar-scene');
  const conn=$('conn-canvas');
  const nebula=$('nebula');
  const grid=$('holo-grid');
  // Cubes + connectors move together (1√ó parallax)
  if(scene) scene.style.transform=`translate(${gyroX}px,${gyroY}px)`;
  if(conn)  conn.style.transform= `translate(${gyroX}px,${gyroY}px)`;
  // Background layers move at different depths for 3D feel
  if(nebula) nebula.style.transform=`translate(${gyroX*2}px,${gyroY*2}px)`;
  if(grid)   grid.style.transform=  `translate(${gyroX*.4}px,${gyroY*.4}px)`;
  requestAnimationFrame(gyroParallaxLoop);
}

function startAR(){
  arMode=true;
  initSpaceBackground();
  initGyroscope();
  gyroParallaxLoop();
  positionCubes();
  setTimeout(()=>{
    drawConnectors();
    toast('üì± Inclina el celular para explorar el espacio','#00d4ff',3500);
  },500);
  setTimeout(()=>toast('üëÜ Toca un cubo para ver sus c√°lculos','#00ff88',3000),4200);
  window.addEventListener('resize',()=>{positionCubes();setTimeout(drawConnectors,100);});
}

// desktop AR launch
function launchAR(){
  $('ar-view').style.display='flex';
  $('desktop-view').style.display='none';
  $('btn-exit').style.display='flex';
  startAR();
}
function exitAR(){
  $('ar-view').style.display='none';
  $('desktop-view').style.display='flex';
  $('btn-exit').style.display='none';
  arMode=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUBE POSITIONING (responsive grid)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function positionCubes(){
  const W=window.innerWidth,H=window.innerHeight;
  const kH=140; // keyboard area reserved
  const avH=H-kH;
  // 2√ó2 grid with some breathing room
  const pad=18;
  const cW=120,cH=170; // cube card estimated size
  const col1=pad, col2=W-pad-cW;
  const row1=50+Math.max(parseInt(getComputedStyle(document.documentElement).getPropertyValue('--sat')||0),14);
  const row2=row1+avH/2-20;
  const positions={
    'arc-ram':  {l:col1,            t:row1},
    'arc-cache':{l:(W-cW)/2,        t:row1-20},
    'arc-reg':  {l:col2,            t:row1},
    'arc-ula':  {l:(W-cW)/2,        t:row2},
  };
  Object.entries(positions).forEach(([id,pos])=>{
    const el=$(id);
    if(el){el.style.left=pos.l+'px';el.style.top=pos.t+'px';}
  });
  // tell step-banner where keyboard starts
  document.getElementById('ar-view').style.setProperty('--kbd-h',kH+'px');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONNECTOR CANVAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawConnectors(){
  const canvas=$('conn-canvas');if(!canvas)return;
  const av=$('ar-view');
  canvas.width=av.offsetWidth;canvas.height=av.offsetHeight;
  const ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const ids=['arc-ram','arc-cache','arc-reg','arc-ula'];
  const cx={};
  ids.forEach(id=>{
    const el=$(id);if(!el)return;
    const r=el.getBoundingClientRect(),a=av.getBoundingClientRect();
    cx[id]={x:r.left-a.left+r.width/2,y:r.top-a.top+r.height*.55};
  });
  const links=[
    ['arc-ram','arc-cache','#00d4ff'],
    ['arc-cache','arc-reg','#ff2d78'],
    ['arc-reg','arc-ula','#00ff88'],
    ['arc-ula','arc-ram','rgba(0,255,136,.25)'],
  ];
  ctx.setLineDash([5,6]);
  links.forEach(([a,b,col])=>{
    if(!cx[a]||!cx[b])return;
    const g=ctx.createLinearGradient(cx[a].x,cx[a].y,cx[b].x,cx[b].y);
    g.addColorStop(0,col.includes('rgba')?col:col+'70');
    g.addColorStop(1,col.includes('rgba')?col:col+'15');
    ctx.beginPath();ctx.moveTo(cx[a].x,cx[a].y);ctx.lineTo(cx[b].x,cx[b].y);
    ctx.strokeStyle=g;ctx.lineWidth=1.2;ctx.stroke();
  });
  ctx.setLineDash([]);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer=null;
function toast(msg,dur=2000,col='var(--blue)'){
  const t=$('toast');if(!t)return;
  t.textContent=msg;t.style.borderColor=col;t.style.color=col;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),dur);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STEP BANNER (AR)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showBanner(msg,col){
  const b=$('step-banner');if(!b)return;
  b.textContent=msg;b.style.color=col;b.style.borderColor=col+'88';
  b.classList.add('show');
}
function hideBanner(){const b=$('step-banner');if(b)b.classList.remove('show')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CUBE ACTIVE FLASH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function flashARC(name,col){
  // AR 3D cube
  const el=$(`arc-${name}`);
  if(el){
    el.style.color=col;
    el.classList.add('active-glow');
    el.querySelector('.cube3').style.filter=`drop-shadow(0 0 16px ${col})`;
    setTimeout(()=>{el.classList.remove('active-glow');el.querySelector('.cube3').style.filter='';},900);
  }
  // Desktop SVG cube
  const dc=$(`cube-${name}`);
  if(dc){
    const polys=dc.querySelectorAll('polygon');
    polys.forEach(p=>{p.setAttribute('stroke',col);p.setAttribute('stroke-width','3');p.style.filter=`drop-shadow(0 0 10px ${col})`;});
    setTimeout(()=>polys.forEach(p=>{p.setAttribute('stroke-width','1.5');p.style.filter='';}),900);
  }
}
function pulseCube(name){
  const pMap={ram:[195,265],cache:[455,138],reg:[715,268],ula:[455,400]};
  const cMap={ram:'#00d4ff',cache:'#ff2d78',reg:'#00ff88',ula:'#ff9900'};
  const el=$(`pulse-${name}`);if(!el)return;
  const[px,py]=pMap[name],col=cMap[name];
  el.setAttribute('cx',px);el.setAttribute('cy',py);el.setAttribute('stroke',col);
  el.setAttribute('rx','0');el.setAttribute('ry','0');el.setAttribute('opacity','0.7');
  let rx=0,ry=0,op=0.7;
  const iv=setInterval(()=>{rx+=4;ry+=3;op-=0.035;if(op<=0){clearInterval(iv);el.setAttribute('opacity','0');return;}
    el.setAttribute('rx',rx);el.setAttribute('ry',ry);el.setAttribute('opacity',op);},20);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AR BIT PARTICLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shootARBits(fromId,toId,bits,col,n=6){
  return new Promise(res=>{
    const from=$(`arc-${fromId}`),to=$(`arc-${toId}`);
    const layer=$('bit-layer');
    if(!from||!to||!layer){res();return;}
    const av=$('ar-view').getBoundingClientRect();
    const fr=from.getBoundingClientRect(),tr=to.getBoundingClientRect();
    const x1=fr.left-av.left+fr.width/2, y1=fr.top-av.top+fr.height*.55;
    const x2=tr.left-av.left+tr.width/2, y2=tr.top-av.top+tr.height*.55;
    const dots=[];
    for(let i=0;i<n;i++){
      const d=document.createElement('div');
      d.className='bit-dot';
      d.textContent=bits[i%bits.length];
      d.style.background=col.replace('#','').length===6?
        `rgba(${parseInt(col.slice(1,3),16)},${parseInt(col.slice(3,5),16)},${parseInt(col.slice(5,7),16)},0.25)`:'rgba(0,200,255,.2)';
      d.style.boxShadow=`0 0 8px ${col},0 0 18px ${col}`;
      d.style.color='#fff';
      layer.appendChild(d);
      dots.push({d,t:-(i/n)*0.7,done:false});
    }
    let raf;
    function tick(){
      let done=0;
      dots.forEach(p=>{
        if(p.done){done++;return;}
        p.t+=0.02;
        if(p.t<0)return;
        if(p.t>1.05){p.d.style.opacity='0';p.done=true;done++;return;}
        const t=Math.min(p.t,1);
        const cpx=(x1+x2)/2+(y2-y1)*0.25,cpy=(y1+y2)/2-(x2-x1)*0.25;
        const bx=(1-t)*(1-t)*x1+2*(1-t)*t*cpx+t*t*x2;
        const by=(1-t)*(1-t)*y1+2*(1-t)*t*cpy+t*t*y2;
        const op=t<0.08?t*12.5:t>0.88?(1-t)*8.33:1;
        p.d.style.left=(bx-10)+'px';p.d.style.top=(by-10)+'px';p.d.style.opacity=op;
      });
      if(done===dots.length){dots.forEach(p=>p.d.remove());res();return;}
      raf=requestAnimationFrame(tick);
    }
    raf=requestAnimationFrame(tick);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SVG BIT PARTICLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shootSVGBits(pathId,bits,col,n=8,spd=1.5){
  return new Promise(res=>{
    const pathEl=$(pathId);if(!pathEl){res();return;}
    const layer=$('bit-layer-svg');
    const L=pathEl.getTotalLength();
    const pts=[];
    for(let i=0;i<n;i++){
      const g=document.createElementNS('http://www.w3.org/2000/svg','circle');
      g.setAttribute('r','9');g.setAttribute('fill',col);g.setAttribute('opacity','0');g.style.filter='blur(5px)';
      const c=document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('r','5');c.setAttribute('fill',col);c.setAttribute('opacity','0');
      const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
      tx.setAttribute('fill','#fff');tx.setAttribute('font-size','7');tx.setAttribute('font-family','Orbitron');
      tx.setAttribute('text-anchor','middle');tx.setAttribute('dominant-baseline','middle');tx.setAttribute('opacity','0');
      tx.textContent=bits[i%bits.length];
      layer.appendChild(g);layer.appendChild(c);layer.appendChild(tx);
      pts.push({g,c,tx,progress:-(i*L/n),done:false});
    }
    let raf;
    function tick(){
      let dn=0;
      pts.forEach(p=>{
        if(p.done){dn++;return;}
        p.progress+=spd*2.5;
        if(p.progress<0)return;
        if(p.progress>L){p.g.setAttribute('opacity','0');p.c.setAttribute('opacity','0');p.tx.setAttribute('opacity','0');p.done=true;dn++;return;}
        const pt=pathEl.getPointAtLength(p.progress);
        const fade=Math.min(1,(L-p.progress)/(L*.15));
        const fi=Math.min(1,p.progress/(L*.08));
        const op=Math.min(fi,fade);
        p.g.setAttribute('cx',pt.x);p.g.setAttribute('cy',pt.y);p.g.setAttribute('opacity',op*.45);
        p.c.setAttribute('cx',pt.x);p.c.setAttribute('cy',pt.y);p.c.setAttribute('opacity',op);
        p.tx.setAttribute('x',pt.x);p.tx.setAttribute('y',pt.y);p.tx.setAttribute('opacity',op);
      });
      if(dn===pts.length){pts.forEach(p=>{p.g.remove();p.c.remove();p.tx.remove();});res();return;}
      raf=requestAnimationFrame(tick);
    }
    raf=requestAnimationFrame(tick);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FLOW PATH (desktop SVG)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPath(id,dur=700){return new Promise(res=>{const el=$(id);if(!el){res();return;}el.style.opacity='1';let o=0;const iv=setInterval(()=>el.setAttribute('stroke-dashoffset',(o-=4)),25);setTimeout(()=>{clearInterval(iv);el.style.opacity='0';res();},dur);})}
function showLbl(id,dur=500){return new Promise(res=>{const el=$(id);if(!el){res();return;}el.style.opacity='1';setTimeout(()=>{el.style.opacity='0';res();},dur);})}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIPELINE / STEPS (desktop)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPipe(s){['if','id','ex','mem','wb'].forEach(x=>{const e=$('ps-'+x);if(e)e.className='pstage';});if(s){const e=$('ps-'+s);if(e)e.className='pstage ps-'+s;}}
function setStepHL(id){['cs-if','cs-id','cs-ex','cs-wb'].forEach(x=>{const e=$(x);if(e)e.className='cstep';});if(id){const e=$(id);if(e)e.className='cstep act-'+id.split('-')[1];}}
function setHier(id,col){['hie-reg','hie-cache','hie-ram'].forEach(h=>{const e=$(h);if(e)e.style.color='#1a3a5a';});if(id){const e=$(id);if(e)e.style.color=col;}}
function setStepMsg(m,c='#336688'){const e=$('step-msg');if(e){e.textContent=m;e.style.color=c;}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT ‚Äî DESKTOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function dtSetActive(x){
  activeIn=x;
  ['dt-tA','dt-tB'].forEach(id=>{const e=$(id);if(e)e.className='tog-ab'+(id.endsWith(x)?(' act-'+x.toLowerCase()):'');});
  $('dt-fa').className='inp-f'+(x==='A'?' act-a':'');
  $('dt-fb').className='inp-f'+(x==='B'?' act-b':'');
  $('dt-ca').style.display=x==='A'?'inline-block':'none';
  $('dt-cb').style.display=x==='B'?'inline-block':'none';
}
function dtSetOp(op){
  selOp=op;
  ['+','-','√ó'].forEach(o=>{const e=$('dt-op'+o);if(e)e.className='opb'+(op===o?' sel':'');});
  updDesktopDisplays();
}
function dtPressKey(k){
  if(running)return;
  if(k==='clr'){if(activeIn==='A')vA='0';else vB='0';}
  else if(k==='back'){if(activeIn==='A')vA=vA.length>1?vA.slice(0,-1):'0';else vB=vB.length>1?vB.slice(0,-1):'0';}
  else{if(activeIn==='A')vA=vA==='0'?k:(vA.length<4?vA+k:vA);else vB=vB==='0'?k:(vB.length<4?vB+k:vB);}
  updDesktopDisplays();
  syncARInputs();
}
function updDesktopDisplays(){
  const a=parseInt(vA)||0,b=parseInt(vB)||0;
  $('dt-va').innerHTML=vA+(activeIn==='A'?'<span class="cur" id="dt-ca"></span>':'');
  $('dt-vb').innerHTML=vB+(activeIn==='B'?'<span class="cur b" id="dt-cb"></span>':'');
  sv('ram-hex-a',toHex(a));sv('ram-dec-a',a);sv('ram-hex-b',toHex(b));sv('ram-dec-b',b);
  sv('rg-r1',toBin(a));sv('rg-d1',a);sv('rg-r2',toBin(b));sv('rg-d2',b);
  sv('center-label',`${vA} ${selOp} ${vB} = ?`);
}
document.querySelectorAll('.dtk').forEach(btn=>{
  btn.addEventListener('click',e=>{
    dtPressKey(btn.getAttribute('data-k'));
    const r=document.createElement('span');r.className='drip';btn.appendChild(r);setTimeout(()=>r.remove(),400);
    btn.classList.add('press');setTimeout(()=>btn.classList.remove('press'),130);
  });
});
document.addEventListener('keydown',e=>{
  if(arMode)return;
  if(e.key>='0'&&e.key<='9')dtPressKey(e.key);
  else if(e.key==='Backspace')dtPressKey('back');
  else if(e.key==='Delete'||e.key==='Escape')dtPressKey('clr');
  else if(e.key==='Tab'){e.preventDefault();dtSetActive(activeIn==='A'?'B':'A');}
  else if(e.key==='Enter')runSim();
  else if(e.key==='+')dtSetOp('+');
  else if(e.key==='-')dtSetOp('-');
  else if(e.key==='*')dtSetOp('√ó');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT ‚Äî AR KEYBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function arSetActive(x){
  activeIn=x;
  $('kd-tA').className='tog-ab'+(x==='A'?' act-a':'');
  $('kd-tB').className='tog-ab'+(x==='B'?' act-b':'');
  $('kd-fa').className='kd-field'+(x==='A'?' act-a':'');
  $('kd-fb').className='kd-field'+(x==='B'?' act-b':'');
  $('kd-ca').style.display=x==='A'?'inline-block':'none';
  $('kd-cb').style.display=x==='B'?'inline-block':'none';
}
function arSetOp(op){
  selOp=op;
  ['kop+','kop-','kop*'].forEach(id=>{const e=$(id);if(e)e.className='kd-op'+(selOp===id.replace('kop','')?' sel':'');});
}
function arPressKey(k){
  if(running)return;
  if(k==='clr'){if(activeIn==='A')vA='0';else vB='0';}
  else if(k==='back'){if(activeIn==='A')vA=vA.length>1?vA.slice(0,-1):'0';else vB=vB.length>1?vB.slice(0,-1):'0';}
  else{if(activeIn==='A')vA=vA==='0'?k:(vA.length<4?vA+k:vA);else vB=vB==='0'?k:(vB.length<4?vB+k:vB);}
  syncARInputs();
  updDesktopDisplays();
}
function syncARInputs(){
  $('kd-va').innerHTML=vA+(activeIn==='A'?'<span class="kcur" id="kd-ca" style="color:var(--blue)"></span>':'');
  $('kd-vb').innerHTML=vB+(activeIn==='B'?'<span class="kcur" id="kd-cb" style="color:var(--green)"></span>':'');
}
document.querySelectorAll('.kk').forEach(btn=>{
  btn.addEventListener('click',e=>{
    const k=btn.getAttribute('data-k');if(!k)return;
    arPressKey(k);
    const r=document.createElement('span');r.className='krip';btn.appendChild(r);setTimeout(()=>r.remove(),380);
    btn.classList.add('press');setTimeout(()=>btn.classList.remove('press'),120);
  });
});
document.querySelectorAll('.kd-op').forEach(btn=>{
  btn.addEventListener('click',()=>arSetOp(btn.textContent==='+'?'+':btn.textContent==='‚àí'?'-':'√ó'));
});

function toggleKbd(){
  const kd=$('kbd-drawer');const ip=$('inspect');
  if(kd){const o=kd.classList.contains('open');ip&&ip.classList.remove('open');kd.classList.toggle('open',!o);}
}
function arCalc(){$('kbd-drawer').classList.remove('open');runSim();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INSPECT PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openInspect(cube){
  const colors={ram:var_('--blue'),cache:var_('--pink'),reg:var_('--green'),ula:var_('--orange')};
  const names={ram:'RAM',cache:'CACH√â',reg:'REGISTRO',ula:'ULA'};
  const subs={ram:'MEMORIA PRINCIPAL',cache:'L1 / L2 / L3',reg:'BANCO DE REGISTROS',ula:'UNIDAD L√ìGICO ARITM√âTICA'};
  const col=colors[cube];
  const s=simState;
  const ip=$('inspect');

  // Tap animation on cube
  const arc=$(`arc-${cube}`);
  if(arc){arc.classList.add('tapped');setTimeout(()=>arc.classList.remove('tapped'),500);}

  $('inspect-title').textContent=names[cube];
  $('inspect-title').style.color=col;
  $('inspect-sub').textContent=subs[cube];

  const isRunning=running&&s.step.includes(cube==='ram'?'if':cube==='cache'?'id':cube==='ula'?'ex':'wb');
  $('inspect-status').innerHTML=`<span class="ibadge ${running&&isRunning?'computing':running?'active':'idle'}">
    ${running&&isRunning?'<span class="idot"></span>':''}
    ${running&&isRunning?'‚ö° PROCESANDO':running?'‚óè EN CICLO':'‚óã IDLE'}
  </span>`;

  // Build rows
  const row=(key,val,cls,live=false)=>
    `<div class="irow"><div class="ikey">${key}</div><div class="ival ${cls||'c-blue'}${live?' live':''}">${val}</div></div>`;

  let html='';
  if(cube==='ram'){
    html=row('DIRECCI√ìN A','0x1000')+row('VALOR A (HEX)',s.ram.hexA,'c-blue',running)+row('VALOR A (DEC)',s.ram.decA,'c-blue',running)
        +row('DIRECCI√ìN B','0x1004')+row('VALOR B (HEX)',s.ram.hexB,'c-blue')+row('VALOR B (DEC)',s.ram.decB,'c-blue')
        +row('DIR. RESULTADO','0x1008')
        +row('RESULTADO (HEX)',s.ram.hexC,s.ram.hexC!=='??'?'c-yellow':'c-blue',running)
        +row('RESULTADO (DEC)',s.ram.decC,s.ram.decC!=='?'?'c-yellow':'c-blue',running)
        +row('TIPO','DRAM ‚Äî Vol√°til')+row('LATENCIA','~100 ns')+row('CICLOS','~200 ciclos CPU');
  }else if(cube==='cache'){
    html=row('ESTADO',s.cache.status,s.cache.status.includes('HIT')?'c-green':'c-pink',running)
        +row('L1 ‚Äî VALOR A',s.cache.a,'c-pink',running)+row('HIT A',s.cache.hitA,s.cache.hitA.includes('HIT')?'c-green':'c-pink')
        +row('L1 ‚Äî VALOR B',s.cache.b,'c-pink',running)+row('HIT B',s.cache.hitB,s.cache.hitB.includes('HIT')?'c-green':'c-pink')
        +row('L2 ESTADO','idle','c-pink')+row('LATENCIA L1',s.cache.lat)
        +row('LATENCIA L2','~10 ns')+row('TIPO','SRAM ‚Äî Vol√°til');
  }else if(cube==='reg'){
    html=row('R1 (binario)',s.reg.r1,'c-green',running)+row('R1 (decimal)',s.reg.d1,'c-green')
        +row('R2 (binario)',s.reg.r2,'c-green',running)+row('R2 (decimal)',s.reg.d2,'c-green')
        +row('R3 RESULTADO',s.reg.r3,s.reg.r3!=='????????'?'c-yellow':'c-green',running)
        +row('R3 (decimal)',s.reg.d3,s.reg.d3!=='?'?'c-yellow':'c-green',running)
        +row('PC (contador)',s.reg.pc,'c-green')+row('IR (instrucci√≥n)',s.reg.ir,'c-green')
        +row('LATENCIA','< 1 ns')+row('CICLOS','1 ciclo CPU');
  }else if(cube==='ula'){
    html=row('OPERACI√ìN',s.ula.op,'c-orange',running)
        +row('ENTRADA A (bin)',s.ula.a,'c-orange',running)+row('ENTRADA A (dec)',s.ula.da,'c-orange')
        +row('ENTRADA B (bin)',s.ula.b,'c-orange',running)+row('ENTRADA B (dec)',s.ula.db,'c-orange')
        +row('SALIDA (binario)',s.ula.out,s.ula.out!=='????????'?'c-yellow':'c-orange',running)
        +row('RESULTADO (dec)',s.ula.res,s.ula.res!=='?'?'c-yellow':'c-orange',running)
        +row('FLAGS',s.ula.flags,'c-orange')+row('LATENCIA','~2 ns');
  }
  $('inspect-rows').innerHTML=html;
  $('kbd-drawer').classList.remove('open');
  ip.classList.add('open');
}
function closeInspect(){$('inspect').classList.remove('open')}

function var_(v){
  return getComputedStyle(document.documentElement).getPropertyValue(v).trim()||
    {'--blue':'#00d4ff','--pink':'#ff2d78','--green':'#00ff88','--orange':'#ff9900'}[v]||'#fff';
}

// Swipe down to close inspect
let touchY0=0;
$('inspect').addEventListener('touchstart',e=>{touchY0=e.touches[0].clientY;},{passive:true});
$('inspect').addEventListener('touchmove',e=>{if(e.touches[0].clientY-touchY0>60)closeInspect();},{passive:true});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOGGING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function log(msg,cls='ls'){
  const c=$('log-body');if(!c)return;
  const t=new Date().toLocaleTimeString('es',{hour12:false});
  c.innerHTML=`<div style="padding:1px 0;border-bottom:1px solid rgba(10,42,74,.3)" class="${cls}">[${t}] ${msg}</div>`+c.innerHTML;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REFRESH INSPECT IF OPEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function refreshInspect(){
  const ip=$('inspect');
  if(!ip||!ip.classList.contains('open'))return;
  const title=$('inspect-title').textContent;
  const map={'RAM':'ram','CACH√â':'cache','REGISTRO':'reg','ULA':'ula'};
  const cube=map[title];
  if(cube)openInspect(cube);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN SIMULATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runSim(){
  if(running)return;
  const a=parseInt(vA)||0,b=parseInt(vB)||0;
  if(a===0&&b===0){log('Ingresa valores A y B.','ls');if(arMode)toast('‚ö† Ingresa valores A y B primero','var(--orange)');return;}
  running=true;
  const btn=$('calc-btn');if(btn){btn.disabled=true;btn.classList.add('running');}
  const kdCalc=$('kd-calc');if(kdCalc)kdCalc.classList.add('running');

  let result,opName;
  if(selOp==='+'){result=a+b;opName='ADD';}else if(selOp==='-'){result=a-b;opName='SUB';}else{result=(a*b)&0xFFFF;opName='MUL';}
  const binA=toBin(a),binB=toBin(b),binR=toBin(result&0xFF);
  const hexA=toHex(a),hexB=toHex(b),hexR=toHex(result&0xFF);
  const flags=`Z=${result===0?1:0} C=${result>255?1:0} N=${result<0?1:0}`;

  // reset state
  simState.ram={hexA,hexB,hexC:'??',decA:a,decB:b,decC:'?'};
  simState.cache={a:'??',b:'??',hitA:'----',hitB:'----',status:'STANDBY',lat:'~2ns'};
  simState.reg={r1:binA,r2:binB,r3:'????????',d1:a,d2:b,d3:'?',pc:'0x2004',ir:'NOP'};
  simState.ula={a:'00000000',da:0,b:'00000000',db:0,op:opName,out:'????????',res:'?',flags:'Z=? C=? N=?'};
  simState.result={eq:'‚Äî',bin:'',hex:''};simState.step='';
  // reset SVG
  sv('ram-hex-c','??');sv('ram-dec-c','?');sv('ca-a','??');sv('ca-b','??');sv('ca-hit-a','----');sv('ca-hit-b','----');sv('ca-status','STANDBY');
  sv('rg-r3','????????');sv('rg-d3','?');sv('rg-ir','NOP');
  sv('ula-a','00000000');sv('ula-da',0);sv('ula-b','00000000');sv('ula-db',0);
  sv('ula-op',opName);sv('ula-out','????????');sv('ula-res','?');sv('ula-flags','Z=? C=? N=?');
  const up=$('ula-plus');if(up)up.textContent=selOp==='+'?'+':selOp==='-'?'‚àí':'√ó';
  sv('center-label',`${a} ${selOp} ${b} = ?`);
  $('res-big')&&($('res-big').textContent='‚Äî');$('res-bin')&&($('res-bin').textContent='');$('res-hex')&&($('res-hex').textContent='');
  log(`‚ïê‚ïê‚ïê INICIO: ${a} ${selOp} ${b} ‚ïê‚ïê‚ïê`,'lx');

  // ‚îÄ STEP 1: FETCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  simState.step='cs-if';
  setPipe('if');setStepHL('cs-if');setHier('hie-ram','#00d4ff');setStepMsg('‚ë† FETCH ‚Äî Leyendo RAM...','#00d4ff');
  showBanner('‚ë† FETCH ‚Äî RAM ‚Üí CACH√â','#00d4ff');
  log(`FETCH: RAM[0x1000]=${hexA} ‚Üí A=${a}`,'lr');log(`FETCH: RAM[0x1004]=${hexB} ‚Üí B=${b}`,'lr');
  flashARC('ram','#00d4ff');pulseCube('ram');refreshInspect();
  if(arMode)toast('‚ë† FETCH ‚Äî RAM leyendo datos','#00d4ff',1400);
  await Promise.all([
    shootSVGBits('path-rc',binA,'#00d4ff',8,1.5),showPath('path-rc',800),
    arMode?shootARBits('ram','cache',binA,'#00d4ff',7):Promise.resolve()
  ]);showLbl('lbl-rc',500);await wait(120);

  // ‚îÄ STEP 2: CACHE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  simState.step='cs-id';
  setPipe('id');setStepHL('cs-id');setHier('hie-cache','#ff2d78');setStepMsg('‚ë° CACHE HIT ‚Äî Cargando...','#ff2d78');
  showBanner('‚ë° DECODE ‚Äî CACH√â ‚Üí REGISTRO','#ff2d78');
  simState.cache={a,b,hitA:'HIT ‚úì',hitB:'HIT ‚úì',status:'CACHE HIT! ‚úì',lat:'~2ns'};
  sv('ca-a',a);sv('ca-b',b);sv('ca-hit-a','HIT ‚úì');sv('ca-hit-b','HIT ‚úì');sv('ca-status','CACHE HIT! ‚úì');
  log('CACH√â: L1 HIT ‚Äî A y B disponibles','lc');
  flashARC('cache','#ff2d78');pulseCube('cache');refreshInspect();
  if(arMode)toast('‚ë° CACH√â HIT ‚Äî Datos en L1','#ff2d78',1400);
  await Promise.all([
    shootSVGBits('path-cr',binB,'#ff2d78',8,1.5),showPath('path-cr',800),
    arMode?shootARBits('cache','reg',binB,'#ff2d78',7):Promise.resolve()
  ]);showLbl('lbl-cr',500);await wait(120);

  // ‚îÄ STEP 3: REGISTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  setHier('hie-reg','#00ff88');
  simState.reg={r1:binA,r2:binB,r3:'????????',d1:a,d2:b,d3:'?',pc:'0x2004',ir:opName};
  sv('rg-r1',binA);sv('rg-d1',a);sv('rg-r2',binB);sv('rg-d2',b);sv('rg-ir',opName);sv('rg-pc','0x2004');
  log(`REG: R1=${binA}(${a}), R2=${binB}(${b}), IR=${opName}`,'lg');
  flashARC('reg','#00ff88');pulseCube('reg');refreshInspect();await wait(400);

  // ‚îÄ STEP 4: EXECUTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  simState.step='cs-ex';
  setPipe('ex');setStepHL('cs-ex');setStepMsg('‚ë¢ EXECUTE ‚Äî ULA calculando...','#ff9900');
  showBanner('‚ë¢ EXECUTE ‚Äî REGISTRO ‚Üí ULA','#ff9900');
  simState.ula={a:binA,da:a,b:binB,db:b,op:opName,out:'????????',res:'?',flags:'Z=? C=? N=?'};
  sv('ula-a',binA);sv('ula-da',a);sv('ula-b',binB);sv('ula-db',b);
  log(`ULA: ${opName} ${binA} ${selOp} ${binB}`,'lu');
  flashARC('ula','#ff9900');
  if(arMode)toast('‚ë¢ EXECUTE ‚Äî ULA procesando...','#ff9900',1400);
  await Promise.all([
    shootSVGBits('path-ru',binA+binB,'#00ff88',8,1.4),showPath('path-ru',900),
    arMode?shootARBits('reg','ula',binA,'#00ff88',7):Promise.resolve()
  ]);showLbl('lbl-ru',500);pulseCube('ula');
  // scramble
  for(let i=0;i<5;i++){const sc=toBin(Math.floor(Math.random()*256));sv('ula-out',sc);simState.ula.out=sc;refreshInspect();await wait(100);}
  simState.ula={a:binA,da:a,b:binB,db:b,op:opName,out:binR,res:result,flags};
  sv('ula-out',binR);sv('ula-res',result);sv('ula-flags',flags);
  log(`ULA RESULTADO: ${binR} = ${result} | ${flags}`,'lu');refreshInspect();await wait(300);

  // ‚îÄ STEP 5: WRITEBACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  simState.step='cs-wb';
  setPipe('wb');setStepHL('cs-wb');setStepMsg('‚ë£ WRITEBACK ‚Äî Guardando...','#00ff88');
  showBanner('‚ë£ WRITEBACK ‚Äî ULA ‚Üí REGISTRO','#ff9900');
  if(arMode)toast('‚ë£ WRITEBACK ‚Äî Resultado al Registro','#ff9900',1400);
  await Promise.all([
    shootSVGBits('path-ur',binR,'#ff9900',8,1.6),showPath('path-ur',800),
    arMode?shootARBits('ula','reg',binR,'#ff9900',7):Promise.resolve()
  ]);showLbl('lbl-ur',500);
  simState.reg.r3=binR;simState.reg.d3=result;
  sv('rg-r3',binR);sv('rg-d3',result);
  log(`REG: R3=${binR} (${result})`,'lg');flashARC('reg','#00ff88');pulseCube('reg');refreshInspect();await wait(300);

  // ‚îÄ STEP 6: STORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  simState.step='store';
  setPipe('mem');setStepMsg('‚ë§ STORE ‚Üí RAM...','#cc44ff');
  showBanner('‚ë§ STORE ‚Äî REGISTRO ‚Üí RAM','#00ff88');
  if(arMode)toast('‚ë§ STORE ‚Äî Guardando en RAM','#00ff88',1400);
  await Promise.all([
    shootSVGBits('path-rram',binR,'#00ff88',8,1.3),showPath('path-rram',900),
    arMode?shootARBits('reg','ram',binR,'#00ff88',7):Promise.resolve()
  ]);showLbl('lbl-rram',500);
  simState.ram.hexC=hexR;simState.ram.decC=result;
  sv('ram-hex-c',hexR);sv('ram-dec-c',result);
  log(`RAM: [0x1008]=${hexR} ‚Üí C=${result}`,'lr');flashARC('ram','#00d4ff');pulseCube('ram');refreshInspect();await wait(200);

  // ‚îÄ DONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  simState.step='done';
  setPipe(null);setStepHL(null);setHier(null,'');hideBanner();
  simState.result={eq:`${a} ${selOp} ${b} = ${result}`,bin:`BIN: ${binR}`,hex:`HEX: 0x${hexR}`};
  sv('center-label',`${a} ${selOp} ${b} = ${result}`);
  $('res-big')&&($('res-big').textContent=`${a} ${selOp} ${b} = ${result}`);
  $('res-bin')&&($('res-bin').textContent=`BIN: ${binR}`);$('res-hex')&&($('res-hex').textContent=`HEX: 0x${hexR}`);
  setStepMsg('‚úì C√ÅLCULO COMPLETADO','#00ff88');
  log(`‚ïê‚ïê‚ïê RESULTADO: ${a} ${selOp} ${b} = ${result} (0x${hexR}) ‚ïê‚ïê‚ïê`,'lx');
  if(arMode)toast(`‚úì ${a} ${selOp} ${b} = ${result}  (0x${hexR})`,'#00ff88',3500);
  refreshInspect();

  running=false;
  if(btn){btn.disabled=false;btn.classList.remove('running');}
  if(kdCalc)kdCalc.classList.remove('running');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
updDesktopDisplays();
syncARInputs();
log('Sistema listo. Ingresa A y B, presiona CALCULAR.','ls');
if(!isMobile) log('üíª Abre en celular para experiencia AR con c√°mara.','ls');
</script>
</body>
</html>
